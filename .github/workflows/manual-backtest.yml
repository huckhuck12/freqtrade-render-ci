name: Manual Backtest - 8PM Strategy

on:
  workflow_dispatch:
    inputs:
      timerange:
        description: 'Backtest time range (e.g., 20240101-20241231)'
        required: true
        default: '20230101-20241231'
      days:
        description: 'Days of data to download'
        required: true
        default: '730'
      pairs:
        description: 'Trading pairs (comma separated)'
        required: true
        default: 'ETH/USDT:USDT,ADA/USDT:USDT,AVAX/USDT:USDT'

jobs:
  manual-backtest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pip install --upgrade pip
          pip install freqtrade

      - name: Show freqtrade version
        run: freqtrade --version

      - name: Cache freqtrade data
        uses: actions/cache@v4
        with:
          path: user_data/data
          key: freqtrade-manual-${{ hashFiles('config/eightpm_backtest.json') }}-${{ github.event.inputs.timerange }}
          restore-keys: |
            freqtrade-manual-2y-

      - name: Download data
        run: |
          # Convert comma-separated pairs to space-separated
          PAIRS=$(echo "${{ github.event.inputs.pairs }}" | tr ',' ' ')
          
          freqtrade download-data \
            --config config/eightpm_backtest.json \
            --timeframes 1h \
            --pairs $PAIRS \
            --days ${{ github.event.inputs.days }}

      - name: Run backtest
        run: |
          mkdir -p user_data/backtest_results
          freqtrade backtesting \
            --config config/eightpm_backtest.json \
            --strategy EightPMHighLowStrategy \
            --backtest-directory user_data/backtest_results \
            --backtest-filename manual_eightpm_result.json \
            --timerange ${{ github.event.inputs.timerange }}

      - name: Generate detailed report
        run: |
          echo "Backtest result files:"
          ls -lah user_data/backtest_results

          ZIP=$(ls -t user_data/backtest_results/*.zip | head -n 1)
          echo "Using zip: $ZIP"

          mkdir -p /tmp/backtest
          unzip -o "$ZIP" -d /tmp/backtest

          echo "Extracted files:"
          ls -lah /tmp/backtest

          RESULT=$(ls /tmp/backtest/*.json | head -n 1)
          echo "Using result json: $RESULT"

          # Extract all metrics
          PROFIT=$(jq -r '.strategy_comparison[0].profit_total_pct' "$RESULT")
          WINRATE=$(jq -r '.strategy_comparison[0].winrate' "$RESULT")
          TRADES=$(jq -r '.strategy_comparison[0].trades' "$RESULT")
          DRAWDOWN=$(jq -r '.strategy_comparison[0].max_drawdown_account' "$RESULT")
          PROFIT_FACTOR=$(jq -r '.strategy_comparison[0].profit_factor' "$RESULT")
          EXPECTANCY=$(jq -r '.strategy_comparison[0].expectancy' "$RESULT")
          SHARPE=$(jq -r '.strategy_comparison[0].sharpe' "$RESULT")
          CALMAR=$(jq -r '.strategy_comparison[0].calmar' "$RESULT")
          WINS=$(jq -r '.strategy_comparison[0].wins' "$RESULT")
          LOSSES=$(jq -r '.strategy_comparison[0].losses' "$RESULT")

          cat > detailed_report.md <<EOF
          # ğŸ¯ 8PM High/Low Strategy v2.6 - 2å¹´è¯¦ç»†å›æµ‹æŠ¥å‘Š

          ## âš™ï¸ Configuration
          - **Time Range**: ${{ github.event.inputs.timerange }} (2å¹´æ•°æ®)
          - **Trading Pairs**: ${{ github.event.inputs.pairs }}
          - **Data Days**: ${{ github.event.inputs.days }}
          - **Timeframe**: 1 hour
          - **Strategy**: EightPMHighLowStrategy v2.6

          ## ğŸ“Š Performance Summary
          | Metric | Value |
          |--------|-------|
          | ğŸ’° Total Profit | ${PROFIT}% |
          | ğŸ“ˆ Win Rate | ${WINRATE}% |
          | ğŸ” Total Trades | ${TRADES} |
          | âœ… Winning Trades | ${WINS} |
          | âŒ Losing Trades | ${LOSSES} |
          | ğŸ“‰ Max Drawdown | ${DRAWDOWN}% |
          | ğŸ² Profit Factor | ${PROFIT_FACTOR} |
          | ğŸ’¡ Expectancy | ${EXPECTANCY} |
          | ğŸ“ˆ Sharpe Ratio | ${SHARPE} |
          | ğŸ“Š Calmar Ratio | ${CALMAR} |

          ## ğŸ” Strategy Logic v2.6
          The 8PM High/Low Strategy identifies daily extremes at 8 PM and trades reversals:

          ### Entry Conditions (ç²¾å‡†ä¼˜åŒ–)
          - ğŸ• **Time Filter**: 8 PM daily high/low identification
          - ğŸ“Š **Volume Confirmation**: Volume > 1.035x 20-period average (æé«˜æµåŠ¨æ€§è¦æ±‚)
          - ğŸ¯ **Price Confirmation**: 0.03% price reversal confirmation (å‡å°‘å‡ä¿¡å·)
          - ğŸ“ˆ **RSI Filter**: Long<40, Short>60 (æ”¶ç´§æ¡ä»¶æé«˜ç²¾å‡†åº¦)
          - ğŸ¯ **Tolerance**: 0.9% daily extreme tolerance (æé«˜ä¿¡å·è´¨é‡)

          ### Risk Management (ä¼˜åŒ–ç›ˆäºæ¯”)
          - ğŸ›¡ï¸ **Stop Loss**: 1.6% (å‡å°‘ä¸å¿…è¦æ­¢æŸ)
          - ğŸ¯ **Take Profit**: 6.0% (æ”¹å–„ç›ˆäºæ¯”è‡³1:3.75)
          - âš–ï¸ **Risk/Reward**: 1:3.75 ratio (æ˜¾è‘—æ”¹å–„)

          ### Position Sizing (æ™ºèƒ½ä»“ä½)
          - ğŸ¥‡ **ETH**: 2.0x (åŸºäº90%èƒœç‡ä¼˜å¼‚è¡¨ç°)
          - ğŸ¥ˆ **ADA**: 2.5x (å†å²æœ€ä½³è¡¨ç°å¸ç§)
          - ğŸ¥‰ **AVAX**: 1.5x (æ½œåŠ›å¸ç§é€‚åº¦é…ç½®)

          ## ğŸ“ˆ 2å¹´å›æµ‹ä¼˜åŠ¿
          - **æ•°æ®å……åˆ†æ€§**: 730å¤© = 17,520å°æ—¶æ•°æ®ç‚¹
          - **å¸‚åœºå‘¨æœŸè¦†ç›–**: åŒ…å«ç‰›å¸‚ã€ç†Šå¸‚ã€éœ‡è¡å¸‚
          - **ç»Ÿè®¡å¯é æ€§**: å¤§æ ·æœ¬é‡é™ä½éšæœºæ€§å½±å“
          - **é•¿æœŸç¨³å®šæ€§**: éªŒè¯ç­–ç•¥æŒç»­ç›ˆåˆ©èƒ½åŠ›

          ## ğŸ¯ Strategy Validation (2å¹´éªŒè¯)
          $(if [ $(echo "${WINRATE} >= 60" | bc -l) -eq 1 ]; then
            echo "âœ… **ç­–ç•¥è¡¨ç°ä¼˜å¼‚** - 2å¹´èƒœç‡è¶…è¿‡60%ï¼Œé•¿æœŸç¨³å®šç›ˆåˆ©"
          elif [ $(echo "${WINRATE} >= 50" | bc -l) -eq 1 ]; then
            echo "âš ï¸ **ç­–ç•¥è¡¨ç°è‰¯å¥½** - 2å¹´èƒœç‡50-60%ï¼Œå…·å¤‡ç›ˆåˆ©æ½œåŠ›"
          else
            echo "âŒ **ç­–ç•¥éœ€è¦ä¼˜åŒ–** - 2å¹´èƒœç‡ä½äº50%ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæ•´"
          fi)

          ## ğŸ“Š v2.6 æ ¸å¿ƒæ”¹è¿›
          1. **ç²¾å‡†å…¥åœº**: æ”¶ç´§RSI(40/60)å’Œæˆäº¤é‡(1.035)æ¡ä»¶
          2. **ä¼˜åŒ–å‡ºåœº**: æ­¢æŸ1.6%ï¼Œæ­¢ç›ˆ6.0%ï¼Œç›ˆäºæ¯”1:3.75
          3. **æ™ºèƒ½ä»“ä½**: ETH 2.0xï¼ŒADA 2.5xï¼ŒAVAX 1.5x
          4. **æ—¶é—´ç®¡ç†**: ETH 60hï¼ŒADA 48hï¼ŒAVAX 40hå·®å¼‚åŒ–
          5. **2å¹´éªŒè¯**: é•¿æœŸæ•°æ®éªŒè¯ç­–ç•¥ç¨³å®šæ€§å’Œå¯é æ€§

          ---
          *Generated on $(date) by GitHub Actions*
          *Strategy: EightPMHighLowStrategy v2.6 - 2å¹´ç²¾å‡†ä¼˜åŒ–ç‰ˆ*
          EOF

          # Also create a summary for the workflow
          echo "## ğŸ“Š Backtest Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Profit**: ${PROFIT}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Win Rate**: ${WINRATE}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Trades**: ${TRADES}" >> $GITHUB_STEP_SUMMARY
          echo "- **Max Drawdown**: ${DRAWDOWN}%" >> $GITHUB_STEP_SUMMARY

      - name: Upload backtest results
        uses: actions/upload-artifact@v4
        with:
          name: manual-backtest-results-${{ github.event.inputs.timerange }}-${{ github.sha }}
          path: |
            user_data/backtest_results/
            detailed_report.md
          retention-days: 90

      - name: Upload detailed report
        uses: actions/upload-artifact@v4
        with:
          name: detailed-report-${{ github.event.inputs.timerange }}
          path: detailed_report.md
          retention-days: 90